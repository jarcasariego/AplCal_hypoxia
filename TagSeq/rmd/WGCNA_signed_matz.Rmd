---
title: "WGCNA analysis"
author: "Javier Rodriguez Casariego"
date: '2022-09-20'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = '/Volumes/JARC_2T/NSF-CREST_Postdoc/LongTerm_Hypoxia_exp/AplCal_hypoxia/TagSeq')
```


```{r install/load packages, include=FALSE}
# Install if needed 
#install.packages("BiocManager",repos="http://cran.us.r-project.org")
#BiocManager::install(c("AnnotationDbi", "impute", "GO.db", "preprocessCore"))
#install.packages("flashClust",repos="http://cran.us.r-project.org")
#install.packages("WGCNA",dependencies=TRUE,repos="http://cran.us.r-project.org")

library(WGCNA)
library(flashClust)
library(ape)
library(stringr)
library(tidyverse)
library(readxl)
library(DESeq2)
library(Biobase)
library(arrayQualityMetrics)
library(pheatmap)
library(ComplexHeatmap)
options(stringsAsFactors=FALSE)
allowWGCNAThreads()

```

```{r built dataset for WGCNA}
#read in counts and metadata
load("output/counts_and_meta.RData")
# distribution of total counts among samples: are there samples with less the 2 SD counts?
#total counts for each sample
smeans<-apply(countMatrix,2,sum)
lsm<-log(smeans,10)
hist(lsm,breaks=12)
sdl<-sd(lsm)
bads<-which(mean(lsm)-lsm > 2*sdl)
bads
# Consider eliminating AC180Pp, AC193Pp, and AC210Pp

# Build dataset for WGCNA
counts.means <-apply(countMatrix,1,mean)

#keep only genes with count means >=10 and eliminate bads
counts4wgcna <-countMatrix[which(counts.means>=10),-c(which(colnames(countMatrix) == "AC180Pp"), which(colnames(countMatrix) == "AC193Pp"), which(colnames(countMatrix) == "AC210Pp"))]
nrow(counts4wgcna)

sdat2 <-sdat[-c(which(rownames(sdat) == "AC180Pp"), which(rownames(sdat) == "AC193Pp"), which(rownames(sdat) == "AC210Pp")),]
sdat2$batch <- as.factor(sdat2$batch)
dds_4wgcna <- DESeqDataSetFromMatrix(countData = counts4wgcna,
                              colData = sdat2,
                              design = ~ tissue+treatment+batch+treatment:tissue+treatment:batch+treatment:tissue:batch)
str(dds_4wgcna)

#Vsd=varianceStabilizingTransformation(dds)
Vsd=vst(dds_4wgcna)
#e=ExpressionSet(assay(Vsd), AnnotatedDataFrame(as.data.frame(colData(Vsd))))

# running outlier detection
#setwd("/Volumes/JARC_2T/NSF-CREST_Postdoc/LongTerm_Hypoxia_exp/AplCal_hypoxia/TagSeq/output")
#arrayQualityMetrics(e,intgroup=c("tissue","treatment","batch","tissue.group","batch.group"),force=T)
#dev.off()
# open the directory "arrayQualityMetrics report for e" and click on index.html

vsd.wg=assay(Vsd)
datt=t(vsd.wg) 

#Check for genes and samples with too many missing values with goodSamplesGenes. There shouldnâ€™t be any because we performed pre-filtering

gsg = goodSamplesGenes(datt, verbose = 3)
gsg$allOK

sampleTree = hclust(dist(datt), method = "average");
# Plot the sample tree: Open a graphic output window of size 12 by 9 inches
# The user should change the dimensions if the window is too large or too small.
plot(sampleTree, main = "Sample clustering to detect outliers", sub="", xlab="", cex.lab = 1.5, cex.axis = 1.5, cex.main = 2)

# Ac175A seems like an outlier 
# Eliminate outlier
counts4wgcna <-counts4wgcna[,-c(which(colnames(countMatrix) == "AC175A"))]
nrow(counts4wgcna)

sdat2 <-sdat2[-c(which(rownames(sdat) == "AC175A")),]
sdat2$batch <- as.factor(sdat2$batch)
dds_4wgcna <- DESeqDataSetFromMatrix(countData = counts4wgcna,
                              colData = sdat2,
                              design = ~ tissue+treatment+batch+treatment:tissue+treatment:batch+treatment:tissue:batch)
str(dds_4wgcna)

#Vsd=varianceStabilizingTransformation(dds)
Vsd=vst(dds_4wgcna)
vsd.wg=assay(Vsd)
datt=t(vsd.wg) 

# assembling table of QUANTITATIVE traits: dummy quantitative variables instead of categorical factor levels:
ganglia=as.numeric(sdat2$tissue=="A")
batch=as.numeric(sdat2$batch=="60")
Control=as.numeric(sdat2$treatment=="Control")
Hyp_T2h=as.numeric(sdat2$treatment=="Hyp_T2h")
Hyp_T6h=as.numeric(sdat2$treatment=="Hyp_T6h")
Reox=as.numeric(sdat2$treatment=="Reox")
Recovery=as.numeric(sdat2$treatment=="Recovery")
LtH_6=as.numeric(sdat2$treatment=="LtH_6")
LtH_7=as.numeric(sdat2$treatment=="LtH_7")
traits=data.frame(cbind(ganglia,batch,Control,Hyp_T2h,Hyp_T6h,Reox,LtH_6,LtH_7,Recovery))
traits

save(vsd.wg,sdat2,datt,traits,file="output/data4wgcna.RData")

```

```{r determine WGCNA parameters}

# Try different betas ("soft threshold") - power factor for calling connections between genes

powers = c(seq(from = 2, to=26, by=2))
# Call the network topology analysis function
# *Decide if you want signed or unsigned network type
sft = pickSoftThreshold(datt, powerVector = powers, verbose = 5,networkType="signed")

# Plot the results:
sizeGrWindow(9, 5)
pdf("output/soft_threshold_signed.pdf",height=4, width=8)
par(mfrow = c(1,2));
cex1 = 0.9;
# Scale-free topology fit index as a function of the soft-thresholding power
plot(sft$fitIndices[,1], -sign(sft$fitIndices[,3])*sft$fitIndices[,2],
xlab="Soft Threshold (power)",ylab="Scale Free Topology Model Fit,signed R^2",type="n",
main = paste("Scale independence"));
text(sft$fitIndices[,1], -sign(sft$fitIndices[,3])*sft$fitIndices[,2],
labels=powers,cex=cex1,col="red");
# this line corresponds to using an R^2 cut-off of h
abline(h=0.90,col="red")
# Mean connectivity as a function of the soft-thresholding power
plot(sft$fitIndices[,1], sft$fitIndices[,5],
xlab="Soft Threshold (power)",ylab="Mean Connectivity", type="n",
main = paste("Mean connectivity"))
text(sft$fitIndices[,1], sft$fitIndices[,5], labels=powers, cex=cex1,col="red")
dev.off()

# 6 looks like the good threshold to use

```
## The next section is run in a cluster (see WGCNA_TOMandModules.R)
## Back to local

```{r WGCNA module analysis}

load('output/1stPassModules.RData')
load('output/data4wgcna.RData')

MEDissThres = 0.15 # in the first pass, set this to 0 - no merging (we want to see the module-traits heatmap first, then decide which modules are telling us the same story and better be merged)
sizeGrWindow(7, 6)
plot(METree, main = "Clustering of module eigengenes",
xlab = "", sub = "")
# Plot the cut line into the dendrogram
abline(h=MEDissThres, col = "red")  # on 2nd pass: does this cut height meet your merging goals? If not, reset MEDissThres and replot

##To choose a threshold, the Height axis will show numbers where the modules will connect together

# Call an automatic merging function
merge = mergeCloseModules(datt, dynamicColors, cutHeight = MEDissThres, verbose = 3)
# The merged module colors
mergedColors = merge$colors;
# Eigengenes of the new merged modules:
mergedMEs = merge$newMEs

# plotting the fabulous ridiculogram
plotDendroAndColors(geneTree, cbind(dynamicColors, mergedColors),
c("Dynamic Tree Cut", "Merged dynamic"),
dendroLabels = FALSE, hang = 0.03,
addGuide = FALSE, guideHang = 0.05,lwd=0.3)

# Rename to moduleColors
moduleColors = mergedColors
# Construct numerical labels corresponding to the colors
colorOrder = c("grey", standardColors(50));
moduleLabels = match(moduleColors, colorOrder)-1;
MEs = mergedMEs;

# Calculate dissimilarity of module eigengenes
MEDiss = 1-cor(MEs);
# Cluster module eigengenes
METree = flashClust(as.dist(MEDiss), method = "average");
# Plot the result
sizeGrWindow(7, 6)
plot(METree, main = "Clustering of module eigengenes",
xlab = "", sub = "")

# how many genes in each module?
table(moduleColors)
# Save module colors and labels for use in subsequent parts
save(MEs, geneTree, moduleLabels, moduleColors, file = "output/networkdata_signed.RData")
```

```{r correlations between modules and traits}

# plotting correlations with traits:
load(file = "output/networkdata_signed.RData")
load(file = "output/data4wgcna.RData")

# Define numbers of genes and samples
nGenes = ncol(datt);
nSamples = nrow(datt);
# Recalculate MEs with color labels
MEs0 = moduleEigengenes(datt, moduleColors)$eigengenes
MEs = orderMEs(MEs0)

# correlations of genes with eigengenes
moduleGeneCor=cor(MEs,datt)
moduleGenePvalue = corPvalueStudent(moduleGeneCor, nSamples);

moduleTraitCor = cor(MEs, traits, use = "p");
moduleTraitPvalue = corPvalueStudent(moduleTraitCor, nSamples);
moduleTraitStars = cut(moduleTraitPvalue, breaks=c(-Inf, 0.001, 0.01, 0.05, Inf), label=c("***", "**", "*", "")) 

moduleTraitTree = hclust(dist(t(moduleTraitCor)), method = "average");
plot(moduleTraitTree, main = "Clustering of traits", sub="", xlab="", cex.lab = 1.5, cex.axis = 1.5, cex.main = 2)

# module-trait correlations
pdf("output/module_heatmap.pdf", height=14, width=10)
textMatrix = moduleTraitStars;
par(mar = c(6, 8.5, 3, 3));
# Display the correlation values within a heatmap plot
labeledHeatmap(Matrix = moduleTraitCor,
xLabels = names(traits),
yLabels = names(MEs),
ySymbols = names(MEs),
colorLabels = FALSE,
colors = blueWhiteRed(50),
textMatrix = textMatrix,
setStdMargins = FALSE,
cex.text = 1.5,
zlim = c(-1,1),
main = paste("Module-trait relationships"))
dev.off()
print(data.frame(table(moduleColors))) # gives numbers of genes in each module


```
# Attempt at complexHeatmap
```{r heatmap_all ganglia}

#bold sig p-values
#dendrogram with WGCNA MEtree cut-off
#colored y-axis

#Create list of pvalues for eigengene correlation with treatment
heatmappval <- signif(moduleTraitPvalue, 1)

#Make list of heatmap row colors
htmap.colors <- names(MEs)
htmap.colors <- gsub("ME", "", htmap.colors)

pdf(file = "figures/Fig-Module-trait-relationship-heatmap_all.pdf", height = 8.5, width = 8)
ht=Heatmap(moduleTraitCor, name = "Eigengene", column_title = "Module-Trait Eigengene Correlation", 
        col = blueWhiteRed(50), 
        row_names_side = "left", row_dend_side = "left",
        width = unit(4, "in"), height = unit(4.5, "in"), 
        column_order = 1:9, column_dend_reorder = FALSE,
        cluster_rows = METree, row_split = 5, row_gap = unit(2.5, "mm"), border = TRUE,
        cell_fun = function(j, i, x, y, w, h, col) {
        if(heatmappval[i, j] <= 0.05) {
            grid.text(sprintf("%s", heatmappval[i, j]), x, y, gp = gpar(fontsize = 8, fontface = "bold"))
        }
        else {
            grid.text(sprintf("%s", heatmappval[i, j]), x, y, gp = gpar(fontsize = 8, fontface = "plain"))
        }},
        column_names_gp =  gpar(fontsize = 10),
row_names_gp = gpar(fontsize = 10, alpha = 0.75, border = TRUE, fill = htmap.colors))
draw(ht)
dev.off()

```
# Create dataframe that associates module colors with clusters based on the above heatmap and the MEtree dendrogram.

```{r create cluster detailed dataframes}
MEcluster1 <- data.frame(moduleColor = c("blue", "red"), moduleCluster = c(1))
MEcluster2 <- data.frame(moduleColor = c("greenyellow"), moduleCluster = c(2))
MEcluster3 <- data.frame(moduleColor = c("tan", "yellow", "green", "purple"), moduleCluster = c(3))
MEcluster4 <- data.frame(moduleColor = c("turquoise"), moduleCluster = c(4))
MEcluster5 <- data.frame(moduleColor = c("brown", "black", "magenta"), moduleCluster = c(5))

moduleCluster = bind_rows(MEcluster1, MEcluster2, MEcluster3, MEcluster4, MEcluster5)
head(moduleCluster)

head(MEs)

Strader_MEs <- MEs
Strader_MEs$treatment <- as.character(sdat2$treatment)
Strader_MEs$sample_id <- rownames(Strader_MEs)
head(Strader_MEs)

##Calculate five over-arching expression patterns using mean eigengene for each module in a cluster


C1_Strader_MEs <- select(Strader_MEs, MEblue:MEred)
C1_Strader_MEs$Mean <- rowMeans(C1_Strader_MEs)
C3_Strader_MEs <- select(Strader_MEs, MEtan:MEpurple)
C3_Strader_MEs$Mean <- rowMeans(C3_Strader_MEs)
C5_Strader_MEs <- select(Strader_MEs, MEbrown:MEmagenta)
C5_Strader_MEs$Mean <- rowMeans(C5_Strader_MEs)

expressionProfile_data <- as.data.frame(cbind(treatment = Strader_MEs$treatment, cluster1= C1_Strader_MEs$Mean, cluster2 = Strader_MEs$MEgreenyellow, cluster3 = C3_Strader_MEs$Mean, cluster4 = Strader_MEs$MEturquoise, cluster5 = C5_Strader_MEs$Mean))
cols.num <- c(2:6)

expressionProfile_data[cols.num] <- sapply(expressionProfile_data[cols.num],as.numeric)
sapply(expressionProfile_data, class)
dim(expressionProfile_data)
head(expressionProfile_data)

treatment_order <- c("Control","Hyp_T2h","Hyp_T6h","Reox","LtH_6","LtH_7","Recovery")

```

```{r plot cluster eigengene}
# Plot mean module eigengene for each cluster

Cluster1Plot <- expressionProfile_data %>%
        select(treatment, cluster1) %>% 
  group_by(treatment) %>% 
  ggplot(aes(x=treatment, y=cluster1)) +
  geom_jitter(alpha = 0.5) +
  geom_boxplot(alpha=0) +
        scale_x_discrete(limits=treatment_order) +
  #ylim(-0.5,1) +
  ylab("Mean Module Eigenegene") +
  theme_bw() + 
  ggtitle("A) Cluster 1") +
  theme(axis.text.x=element_blank(), #set x-axis label size
        axis.title.x=element_blank(), #set x-axis title size
        axis.ticks.x=element_blank(), #No x-label ticks
        axis.title.y=element_text(size = 14), #No y-axis title
        axis.text.y=element_text(size = 14), #set y-axis label size, #No y-title
        panel.border = element_blank(), # Set border
        panel.grid.major = element_blank(), #Set major gridlines
        panel.grid.minor = element_blank(), #Set minor gridlines
        axis.line = element_line(colour = "black"), #Set axes color
        plot.background=element_blank(),
        plot.title = element_text(size=22)) + #Set the plot background
  annotate("text", x = 1.2, y = 0.5, label = "n = 2", size = 6) +
  geom_hline(yintercept = 0, linetype="dashed", color = "grey") #

Cluster2Plot <- expressionProfile_data %>%
        select(treatment, cluster2) %>% 
  group_by(treatment) %>% 
  ggplot(aes(x=treatment, y=cluster2)) +
  geom_jitter(alpha = 0.5) +
  geom_boxplot(alpha=0) +
        scale_x_discrete(limits=treatment_order) +
  #ylim(-0.5,1) +
  ggtitle("B) Cluster 2") +
  theme_bw() + 
  theme(axis.text.x=element_blank(), #set x-axis label size
        axis.title.x=element_blank(), #set x-axis title size
        axis.ticks.x=element_blank(), #No x-label ticks
        axis.title.y=element_blank(), #No y-axis title
        axis.text.y=element_text(size = 14), #set y-axis label size, #No y-title
        panel.border = element_blank(), # Set border
        panel.grid.major = element_blank(), #Set major gridlines
        panel.grid.minor = element_blank(), #Set minor gridlines
        axis.line = element_line(colour = "black"), #Set axes color
        plot.background=element_blank(),
        plot.title = element_text(size=22)) + #Set the plot background
  annotate("text", x = 1.2, y = 0.5, label = "n = 1", size = 6)  +
  geom_hline(yintercept = 0, linetype="dashed", color = "grey") #
Cluster3Plot <- expressionProfile_data %>%
        select(treatment, cluster3) %>% 
  group_by(treatment) %>% 
  ggplot(aes(x=treatment, y=cluster3)) +
  geom_jitter(alpha = 0.5) +
  geom_boxplot(alpha=0) +
        scale_x_discrete(limits=treatment_order) +
  #ylim(-0.5,1) +
  ggtitle("C) Cluster 3") +
  theme_bw() + 
 theme(axis.text.x=element_blank(), #set x-axis label size
        axis.title.x=element_blank(), #set x-axis title size
        axis.ticks.x=element_blank(), #No x-label ticks
        axis.title.y=element_blank(), #No y-axis title
        axis.text.y=element_text(size = 14), #set y-axis label size, #No y-title
        panel.border = element_blank(), # Set border
        panel.grid.major = element_blank(), #Set major gridlines
        panel.grid.minor = element_blank(), #Set minor gridlines
        axis.line = element_line(colour = "black"), #Set axes color
        plot.background=element_blank(),
        plot.title = element_text(size=22)) + #Set the plot background
  annotate("text", x = 1.2, y = 0.5, label = "n = 4", size = 6)  +
  geom_hline(yintercept = 0, linetype="dashed", color = "grey")
Cluster4Plot <- expressionProfile_data %>%
        select(treatment, cluster4) %>% 
  group_by(treatment) %>% 
  ggplot(aes(x=treatment, y=cluster4)) +
  geom_jitter(alpha = 0.5) +
  geom_boxplot(alpha=0) +
        scale_x_discrete(limits=treatment_order) +
  #ylim(-0.5,1) +
  ggtitle("D) Cluster 4") +
  ylab("Mean Module Eigenegene") +
  theme_bw() + 
 theme(axis.text.x=element_blank(), #set x-axis label size
        axis.title.x=element_blank(), #set x-axis title size
        axis.ticks.x=element_blank(), #No x-label ticks
        axis.title.y=element_text(size = 14), #No y-axis title
        axis.text.y=element_text(size = 14), #set y-axis label size, #No y-title
        panel.border = element_blank(), # Set border
        panel.grid.major = element_blank(), #Set major gridlines
        panel.grid.minor = element_blank(), #Set minor gridlines
        axis.line = element_line(colour = "black"), #Set axes color
        plot.background=element_blank(),
        plot.title = element_text(size=22)) + #Set the plot background
  annotate("text", x = 1.2, y = 0.5, label = "n = 1", size = 6)  +
  geom_hline(yintercept = 0, linetype="dashed", color = "grey")
Cluster5Plot <- expressionProfile_data %>%
        select(treatment, cluster5) %>% 
  group_by(treatment) %>% 
  ggplot(aes(x=treatment, y=cluster5)) +
  geom_jitter(alpha = 0.5) +
  geom_boxplot(alpha=0) +
        scale_x_discrete(limits=treatment_order) +
  #ylim(-0.5,1) +
  ggtitle("E) Cluster 5") +
  theme_bw() + 
 theme(axis.text.x=element_blank(), #set x-axis label size
        axis.title.x=element_blank(), #set x-axis title size
        axis.ticks.x=element_blank(), #No x-label ticks
        axis.title.y=element_blank(), #No y-axis title
        axis.text.y=element_text(size = 14), #set y-axis label size, #No y-title
        panel.border = element_blank(), # Set border
        panel.grid.major = element_blank(), #Set major gridlines
        panel.grid.minor = element_blank(), #Set minor gridlines
        axis.line = element_line(colour = "black"), #Set axes color
        plot.background=element_blank(),
        plot.title = element_text(size=22)) + #Set the plot background
  annotate("text", x = 1.2, y = 0.5, label = "n = 3", size = 6) +
  geom_hline(yintercept = 0, linetype="dashed", color = "grey")

expressionProfiles <- cowplot::plot_grid(Cluster1Plot, Cluster2Plot, Cluster3Plot, Cluster4Plot, Cluster5Plot, align = "v", ncol = 3, nrow = 2)
ggsave("figures/SFig1-RNAseq-expressionProfiles_all.png", expressionProfiles, height = 16, width = 21, units = "in")
```



# Separate by ganglia and run individual networks

```{r separate by ganglia}

#keep only Abdominal
sdat_A <- sdat2[which(sdat2$tissue == "A"),]
counts4wgcna_A <-counts4wgcna[, which(colnames(counts4wgcna)%in%rownames(sdat_A))]
sdat_A$batch <- as.factor(sdat_A$batch)
dds_4wgcna_A <- DESeqDataSetFromMatrix(countData = counts4wgcna_A,
                              colData = sdat_A,
                              design = ~ treatment+batch+treatment:batch)
str(dds_4wgcna_A)
Vsd_A=vst(dds_4wgcna_A)
vsd.wg_A=assay(Vsd_A)
datt_A=t(vsd.wg_A) 

#keep only Plural/Pedal
sdat_P <- sdat2[which(sdat2$tissue == "Pp"),]
counts4wgcna_P <-counts4wgcna[, which(colnames(counts4wgcna)%in%rownames(sdat_P))]
sdat_P$batch <- as.factor(sdat_P$batch)
dds_4wgcna_P <- DESeqDataSetFromMatrix(countData = counts4wgcna_P,
                              colData = sdat_P,
                              design = ~ treatment+batch+treatment:batch)
str(dds_4wgcna_P)
Vsd_P=vst(dds_4wgcna_P)
vsd.wg_P=assay(Vsd_P)
datt_P=t(vsd.wg_P) 

# assembling table of QUANTITATIVE traits for both tissue datasets: dummy quantitative variables instead of categorical factor levels:
batch=as.numeric(sdat_A$batch=="60")
Control=as.numeric(sdat_A$treatment=="Control")
Hyp_T2h=as.numeric(sdat_A$treatment=="Hyp_T2h")
Hyp_T6h=as.numeric(sdat_A$treatment=="Hyp_T6h")
Reox=as.numeric(sdat_A$treatment=="Reox")
Recovery=as.numeric(sdat_A$treatment=="Recovery")
LtH_6=as.numeric(sdat_A$treatment=="LtH_6")
LtH_7=as.numeric(sdat_A$treatment=="LtH_7")
traits_A=data.frame(cbind(batch,Control,Hyp_T2h,Hyp_T6h,Reox,LtH_6,LtH_7,Recovery))
traits_A

batch=as.numeric(sdat_P$batch=="60")
Control=as.numeric(sdat_P$treatment=="Control")
Hyp_T2h=as.numeric(sdat_P$treatment=="Hyp_T2h")
Hyp_T6h=as.numeric(sdat_P$treatment=="Hyp_T6h")
Reox=as.numeric(sdat_P$treatment=="Reox")
Recovery=as.numeric(sdat_P$treatment=="Recovery")
LtH_6=as.numeric(sdat_P$treatment=="LtH_6")
LtH_7=as.numeric(sdat_P$treatment=="LtH_7")
traits_P=data.frame(cbind(batch,Control,Hyp_T2h,Hyp_T6h,Reox,LtH_6,LtH_7,Recovery))
traits_P

save(vsd.wg_A,sdat_A,datt_A,traits_A,file="output/data4wgcna_A.RData")
save(vsd.wg_P,sdat_P,datt_P,traits_P,file="output/data4wgcna_P.RData")
```

```{r determine WGCNA parameters for A and P datasets}

# Try different betas ("soft threshold") - power factor for calling connections between genes
# Abdominal
powers = c(seq(from = 2, to=26, by=1))
# Call the network topology analysis function
# *Decide if you want signed or unsigned network type
sft = pickSoftThreshold(datt_A, powerVector = powers, verbose = 5,networkType="signed")

# Plot the results:
sizeGrWindow(9, 5)
pdf("output/soft_threshold_signed_A.pdf",height=4, width=8)
par(mfrow = c(1,2));
cex1 = 0.9;
# Scale-free topology fit index as a function of the soft-thresholding power
plot(sft$fitIndices[,1], -sign(sft$fitIndices[,3])*sft$fitIndices[,2],
xlab="Soft Threshold (power)",ylab="Scale Free Topology Model Fit,signed R^2",type="n",
main = paste("Scale independence"));
text(sft$fitIndices[,1], -sign(sft$fitIndices[,3])*sft$fitIndices[,2],
labels=powers,cex=cex1,col="red");
# this line corresponds to using an R^2 cut-off of h
abline(h=0.90,col="red")
# Mean connectivity as a function of the soft-thresholding power
plot(sft$fitIndices[,1], sft$fitIndices[,5],
xlab="Soft Threshold (power)",ylab="Mean Connectivity", type="n",
main = paste("Mean connectivity"))
text(sft$fitIndices[,1], sft$fitIndices[,5], labels=powers, cex=cex1,col="red")
dev.off()

# 8 looks like the good threshold to use for A

# Pleural/Pedal
powers = c(seq(from = 2, to=26, by=1))
# Call the network topology analysis function
# *Decide if you want signed or unsigned network type
sft = pickSoftThreshold(datt_P, powerVector = powers, verbose = 5,networkType="signed")

# Plot the results:
sizeGrWindow(9, 5)
pdf("output/soft_threshold_signed_P.pdf",height=4, width=8)
par(mfrow = c(1,2));
cex1 = 0.9;
# Scale-free topology fit index as a function of the soft-thresholding power
plot(sft$fitIndices[,1], -sign(sft$fitIndices[,3])*sft$fitIndices[,2],
xlab="Soft Threshold (power)",ylab="Scale Free Topology Model Fit,signed R^2",type="n",
main = paste("Scale independence"));
text(sft$fitIndices[,1], -sign(sft$fitIndices[,3])*sft$fitIndices[,2],
labels=powers,cex=cex1,col="red");
# this line corresponds to using an R^2 cut-off of h
abline(h=0.90,col="red")
# Mean connectivity as a function of the soft-thresholding power
plot(sft$fitIndices[,1], sft$fitIndices[,5],
xlab="Soft Threshold (power)",ylab="Mean Connectivity", type="n",
main = paste("Mean connectivity"))
text(sft$fitIndices[,1], sft$fitIndices[,5], labels=powers, cex=cex1,col="red")
dev.off()

# 7 looks like the good threshold to use for Pp


```

```{r WGCNA module analysis_A}

load('output/1stPassModules_A.RData')
load('output/data4wgcna_A.RData')

MEDissThres = 0.15 # in the first pass, set this to 0 - no merging (we want to see the module-traits heatmap first, then decide which modules are telling us the same story and better be merged)
sizeGrWindow(7, 6)
plot(METree_A, main = "Clustering of module eigengenes",
xlab = "", sub = "")
# Plot the cut line into the dendrogram
abline(h=MEDissThres, col = "red")  # on 2nd pass: does this cut height meet your merging goals? If not, reset MEDissThres and replot

##To choose a threshold, the Height axis will show numbers where the modules will connect together

# Call an automatic merging function
merge_A = mergeCloseModules(datt_A, dynamicColors_A, cutHeight = MEDissThres, verbose = 3)
# The merged module colors
mergedColors_A = merge_A$colors;
# Eigengenes of the new merged modules:
mergedMEs_A = merge_A$newMEs

# plotting the fabulous ridiculogram
plotDendroAndColors(geneTree_A, cbind(dynamicColors_A, mergedColors_A),
c("Dynamic Tree Cut", "Merged dynamic"),
dendroLabels = FALSE, hang = 0.03,
addGuide = FALSE, guideHang = 0.05,lwd=0.3)

# Rename to moduleColors
moduleColors_A = mergedColors_A
# Construct numerical labels corresponding to the colors
colorOrder = c("grey", standardColors(50));
moduleLabels_A = match(moduleColors_A, colorOrder)-1;
MEs_A = mergedMEs_A;

# Calculate dissimilarity of module eigengenes
MEDiss_A = 1-cor(MEs_A);
# Cluster module eigengenes
METree_A = flashClust(as.dist(MEDiss_A), method = "average");
# Plot the result
sizeGrWindow(7, 6)
plot(METree_A, main = "Clustering of module eigengenes",
xlab = "", sub = "")

# how many genes in each module?
table(moduleColors_A)
# Save module colors and labels for use in subsequent parts
save(MEs_A, geneTree_A, moduleLabels_A, moduleColors_A, file = "output/networkdata_signed_A.RData")
```

```{r correlations between modules and traits for Abdominal}

# plotting correlations with traits:
load(file = "output/networkdata_signed_A.RData")
load(file = "output/data4wgcna_A.RData")

# Define numbers of genes and samples
nGenes = ncol(datt_A);
nSamples = nrow(datt_A);
# Recalculate MEs with color labels
MEs0_A = moduleEigengenes(datt_A, moduleColors_A)$eigengenes
MEs_A = orderMEs(MEs0_A)

# correlations of genes with eigengenes
moduleGeneCor_A=cor(MEs_A,datt_A)
moduleGenePvalue_A = corPvalueStudent(moduleGeneCor_A, nSamples);

moduleTraitCor_A = cor(MEs_A, traits_A, use = "p");
moduleTraitPvalue_A = corPvalueStudent(moduleTraitCor_A, nSamples);
moduleTraitStars_A = cut(moduleTraitPvalue_A, breaks=c(-Inf, 0.001, 0.01, 0.05, Inf), label=c("***", "**", "*", "")) 

moduleTraitTree_A = hclust(dist(t(moduleTraitCor_A)), method = "average");
plot(moduleTraitTree_A, main = "Clustering of traits", sub="", xlab="", cex.lab = 1.5, cex.axis = 1.5, cex.main = 2)

# module-trait correlations
pdf("output/module_heatmap_A.pdf", height=14, width=10)
textMatrix = moduleTraitStars_A;
par(mar = c(6, 8.5, 3, 3));
# Display the correlation values within a heatmap plot
labeledHeatmap(Matrix = moduleTraitCor_A,
xLabels = names(traits_A),
yLabels = names(MEs_A),
ySymbols = names(MEs_A),
colorLabels = FALSE,
colors = blueWhiteRed(50),
textMatrix = textMatrix,
setStdMargins = FALSE,
cex.text = 1.5,
zlim = c(-1,1),
main = paste("Module-trait relationships of Abdominal ganglion"))
dev.off()
print(data.frame(table(moduleColors_A))) # gives numbers of genes in each module

```

```{r heatmap _A}

#bold sig p-values
#dendrogram with WGCNA MEtree cut-off
#colored y-axis

#Create list of pvalues for eigengene correlation with treatment
heatmappval <- signif(moduleTraitPvalue_A, 1)

#Make list of heatmap row colors
htmap.colors <- names(MEs_A)
htmap.colors <- gsub("ME", "", htmap.colors)

pdf(file = "figures/Fig-Module-trait-relationship-heatmap_Abdominal.pdf", height = 8.5, width = 8)
ht=Heatmap(moduleTraitCor_A, name = "Eigengene", column_title = "Module-Trait Eigengene Correlation", 
        col = blueWhiteRed(50), 
        row_names_side = "left", row_dend_side = "left",
        width = unit(4, "in"), height = unit(4.5, "in"), 
        column_order = 1:8, column_dend_reorder = FALSE,
        cluster_rows = METree_A, row_split = 4, row_gap = unit(2.5, "mm"), border = TRUE,
        cell_fun = function(j, i, x, y, w, h, col) {
        if(heatmappval[i, j] <= 0.05) {
            grid.text(sprintf("%s", heatmappval[i, j]), x, y, gp = gpar(fontsize = 8, fontface = "bold"))
        }
        else {
            grid.text(sprintf("%s", heatmappval[i, j]), x, y, gp = gpar(fontsize = 8, fontface = "plain"))
        }},
        column_names_gp =  gpar(fontsize = 10),
row_names_gp = gpar(fontsize = 10, alpha = 0.75, border = TRUE, fill = htmap.colors))
draw(ht)
dev.off()

```

```{r create cluster detailed dataframes Abdominal}
MEcluster1 <- data.frame(moduleColor = c("turquoise"), moduleCluster = c(1))
MEcluster2 <- data.frame(moduleColor = c("purple","red","blue","magenta"), moduleCluster = c(2))
MEcluster3 <- data.frame(moduleColor = c("brown"), moduleCluster = c(3))
MEcluster4 <- data.frame(moduleColor = c("pink","black","green"), moduleCluster = c(4))

moduleCluster = bind_rows(MEcluster1, MEcluster2, MEcluster3, MEcluster4)
head(moduleCluster)

head(MEs_A)

Strader_MEs_A <- MEs_A
Strader_MEs_A$treatment <- as.character(sdat_A$treatment)
Strader_MEs_A$sample_id <- rownames(Strader_MEs_A)
head(Strader_MEs_A)

##Calculate five over-arching expression patterns using mean eigengene for each module in a cluster


C2_Strader_MEs_A <- select(Strader_MEs_A, MEpurple:MEmagenta)
C2_Strader_MEs_A$Mean <- rowMeans(C2_Strader_MEs_A)
C4_Strader_MEs_A <- select(Strader_MEs_A, MEpink:MEgreen)
C4_Strader_MEs_A$Mean <- rowMeans(C4_Strader_MEs_A)


expressionProfile_data_A <- as.data.frame(cbind(treatment = Strader_MEs_A$treatment, cluster1= Strader_MEs_A$MEturquoise, cluster2 = C2_Strader_MEs_A$Mean, cluster3 = Strader_MEs_A$MEbrown, cluster4 = C4_Strader_MEs_A$Mean))
cols.num <- c(2:5)

expressionProfile_data_A[cols.num] <- sapply(expressionProfile_data_A[cols.num],as.numeric)
sapply(expressionProfile_data_A, class)
dim(expressionProfile_data_A)
head(expressionProfile_data_A)

treatment_order <- c("Control","Hyp_T2h","Hyp_T6h","Reox","LtH_6","LtH_7","Recovery")

```

```{r plot cluster eigengene}
# Plot mean module eigengene for each cluster

Cluster1Plot <- expressionProfile_data_A %>%
        select(treatment, cluster1) %>% 
  group_by(treatment) %>% 
  ggplot(aes(x=treatment, y=cluster1)) +
  geom_jitter(alpha = 0.5) +
  geom_boxplot(alpha=0) +
        scale_x_discrete(limits=treatment_order) +
  #ylim(-0.5,1) +
  ylab("Mean Module Eigenegene") +
  theme_bw() + 
  ggtitle("Cluster 1") +
  theme(axis.text.x=element_blank(), #set x-axis label size
        axis.title.x=element_blank(), #set x-axis title size
        axis.ticks.x=element_blank(), #No x-label ticks
        axis.title.y=element_text(size = 14), #No y-axis title
        axis.text.y=element_text(size = 14), #set y-axis label size, #No y-title
        panel.border = element_blank(), # Set border
        panel.grid.major = element_blank(), #Set major gridlines
        panel.grid.minor = element_blank(), #Set minor gridlines
        axis.line = element_line(colour = "black"), #Set axes color
        plot.background=element_blank(),
        plot.title = element_text(size=16)) + #Set the plot background
  annotate("text", x = 1.2, y = 0.5, label = "n = 1", size = 4) +
  geom_hline(yintercept = 0, linetype="dashed", color = "grey") #

Cluster2Plot <- expressionProfile_data_A %>%
        select(treatment, cluster2) %>% 
  group_by(treatment) %>% 
  ggplot(aes(x=treatment, y=cluster2)) +
  geom_jitter(alpha = 0.5) +
  geom_boxplot(alpha=0) +
        scale_x_discrete(limits=treatment_order) +
  #ylim(-0.5,1) +
  ggtitle("Cluster 2") +
  theme_bw() + 
  theme(axis.text.x=element_blank(), #set x-axis label size
        axis.title.x=element_blank(), #set x-axis title size
        axis.ticks.x=element_blank(), #No x-label ticks
        axis.title.y=element_blank(), #No y-axis title
        axis.text.y=element_text(size = 14), #set y-axis label size, #No y-title
        panel.border = element_blank(), # Set border
        panel.grid.major = element_blank(), #Set major gridlines
        panel.grid.minor = element_blank(), #Set minor gridlines
        axis.line = element_line(colour = "black"), #Set axes color
        plot.background=element_blank(),
        plot.title = element_text(size=16)) + #Set the plot background
  annotate("text", x = 1.2, y = 0.5, label = "n = 4", size = 4)  +
  geom_hline(yintercept = 0, linetype="dashed", color = "grey") #
Cluster3Plot <- expressionProfile_data_A %>%
        select(treatment, cluster3) %>% 
  group_by(treatment) %>% 
  ggplot(aes(x=treatment, y=cluster3)) +
  geom_jitter(alpha = 0.5) +
  geom_boxplot(alpha=0) +
        scale_x_discrete(limits=treatment_order) +
  #ylim(-0.5,1) +
  ylab("Mean Module Eigenegene") +
  ggtitle("Cluster 3") +
  theme_bw() + 
 theme(axis.text.x=element_blank(), #set x-axis label size
        axis.title.x=element_blank(), #set x-axis title size
        axis.ticks.x=element_blank(), #No x-label ticks
        axis.title.y=element_text(size = 14), 
        axis.text.y=element_text(size = 14), #set y-axis label size, #No y-title
        panel.border = element_blank(), # Set border
        panel.grid.major = element_blank(), #Set major gridlines
        panel.grid.minor = element_blank(), #Set minor gridlines
        axis.line = element_line(colour = "black"), #Set axes color
        plot.background=element_blank(),
        plot.title = element_text(size=16)) + #Set the plot background
  annotate("text", x = 1.2, y = 0.5, label = "n = 1", size = 4)  +
  geom_hline(yintercept = 0, linetype="dashed", color = "grey")
Cluster4Plot <- expressionProfile_data_A %>%
        select(treatment, cluster4) %>% 
  group_by(treatment) %>% 
  ggplot(aes(x=treatment, y=cluster4)) +
  geom_jitter(alpha = 0.5) +
  geom_boxplot(alpha=0) +
        scale_x_discrete(limits=treatment_order) +
  #ylim(-0.5,1) +
  ggtitle("Cluster 4") +
  theme_bw() + 
 theme(axis.text.x=element_blank(), #set x-axis label size
        axis.title.x=element_blank(), #set x-axis title size
        axis.ticks.x=element_blank(), #No x-label ticks
        axis.title.y=element_blank(), #No y-axis title
        axis.text.y=element_text(size = 14), #set y-axis label size, #No y-title
        panel.border = element_blank(), # Set border
        panel.grid.major = element_blank(), #Set major gridlines
        panel.grid.minor = element_blank(), #Set minor gridlines
        axis.line = element_line(colour = "black"), #Set axes color
        plot.background=element_blank(),
        plot.title = element_text(size=16)) + #Set the plot background
  annotate("text", x = 1.2, y = 0.5, label = "n = 3", size = 4)  +
  geom_hline(yintercept = 0, linetype="dashed", color = "grey")

expressionProfiles_A <- cowplot::plot_grid(Cluster1Plot, Cluster2Plot, Cluster3Plot, Cluster4Plot, align = "v", ncol = 2, nrow = 2)
ggsave("figures/SFig1-RNAseq-expressionProfiles_Abdominal.png", expressionProfiles_A, height = 6, width = 8, units = "in")

expressionProfiles_A 
```


```{r WGCNA module analysis_P}

load('output/1stPassModules_P.RData')
load('output/data4wgcna_P.RData')

MEDissThres = 0.15 # in the first pass, set this to 0 - no merging (we want to see the module-traits heatmap first, then decide which modules are telling us the same story and better be merged)
sizeGrWindow(7, 6)
plot(METree_P, main = "Clustering of module eigengenes",
xlab = "", sub = "")
# Plot the cut line into the dendrogram
abline(h=MEDissThres, col = "red")  # on 2nd pass: does this cut height meet your merging goals? If not, reset MEDissThres and replot

##To choose a threshold, the Height axis will show numbers where the modules will connect together

# Call an automatic merging function
merge_P = mergeCloseModules(datt_P, dynamicColors_P, cutHeight = MEDissThres, verbose = 3)
# The merged module colors
mergedColors_P = merge_P$colors;
# Eigengenes of the new merged modules:
mergedMEs_P = merge_P$newMEs

# plotting the fabulous ridiculogram
plotDendroAndColors(geneTree_P, cbind(dynamicColors_P, mergedColors_P),
c("Dynamic Tree Cut", "Merged dynamic"),
dendroLabels = FALSE, hang = 0.03,
addGuide = FALSE, guideHang = 0.05,lwd=0.3)

# Rename to moduleColors
moduleColors_P = mergedColors_P
# Construct numerical labels corresponding to the colors
colorOrder = c("grey", standardColors(50));
moduleLabels_P = match(moduleColors_P, colorOrder)-1;
MEs_P = mergedMEs_P;

# Calculate dissimilarity of module eigengenes
MEDiss_P = 1-cor(MEs_P);
# Cluster module eigengenes
METree_P = flashClust(as.dist(MEDiss_P), method = "average");
# Plot the result
sizeGrWindow(7, 6)
plot(METree_P, main = "Clustering of module eigengenes",
xlab = "", sub = "")

# how many genes in each module?
table(moduleColors_P)
# Save module colors and labels for use in subsequent parts
save(MEs_P, geneTree_P, moduleLabels_P, moduleColors_P, file = "output/networkdata_signed_P.RData")
```

```{r correlations between modules and traits for Pleural/Pedal}

# plotting correlations with traits:
load(file = "output/networkdata_signed_P.RData")
load(file = "output/data4wgcna_P.RData")

# Define numbers of genes and samples
nGenes = ncol(datt_P);
nSamples = nrow(datt_P);
# Recalculate MEs with color labels
MEs0_P = moduleEigengenes(datt_P, moduleColors_P)$eigengenes
MEs_P = orderMEs(MEs0_P)

# correlations of genes with eigengenes
moduleGeneCor_P=cor(MEs_P,datt_P)
moduleGenePvalue_P = corPvalueStudent(moduleGeneCor_P, nSamples);

moduleTraitCor_P = cor(MEs_P, traits_P, use = "p");
moduleTraitPvalue_P = corPvalueStudent(moduleTraitCor_P, nSamples);
moduleTraitStars_P = cut(moduleTraitPvalue_P, breaks=c(-Inf, 0.001, 0.01, 0.05, Inf), label=c("***", "**", "*", "")) 

moduleTraitTree_P = hclust(dist(t(moduleTraitCor_P)), method = "average");
plot(moduleTraitTree_P, main = "Clustering of traits", sub="", xlab="", cex.lab = 1.5, cex.axis = 1.5, cex.main = 2)

# module-trait correlations
pdf("output/module_heatmap_P.pdf", height=14, width=10)
textMatrix = moduleTraitStars_P;
par(mar = c(6, 8.5, 3, 3));
# Display the correlation values within a heatmap plot
labeledHeatmap(Matrix = moduleTraitCor_P,
xLabels = names(traits_P),
yLabels = names(MEs_P),
ySymbols = names(MEs_P),
colorLabels = FALSE,
colors = blueWhiteRed(50),
textMatrix = textMatrix,
setStdMargins = FALSE,
cex.text = 1.5,
zlim = c(-1,1),
main = paste("Module-trait relationships of Pleural and Pedal ganglia"))
dev.off()
print(data.frame(table(moduleColors_P))) # gives numbers of genes in each module

```

```{r heatmap _P}

#bold sig p-values
#dendrogram with WGCNA MEtree cut-off
#colored y-axis

#Create list of pvalues for eigengene correlation with treatment
heatmappval <- signif(moduleTraitPvalue_P, 1)

#Make list of heatmap row colors
htmap.colors <- names(MEs_P)
htmap.colors <- gsub("ME", "", htmap.colors)

pdf(file = "figures/Fig-Module-trait-relationship-heatmap_Pleural_n_Pedal.pdf", height = 8.5, width = 8)
ht=Heatmap(moduleTraitCor_P, name = "Eigengene", column_title = "Module-Trait Eigengene Correlation", 
        col = blueWhiteRed(50), 
        row_names_side = "left", row_dend_side = "left",
        width = unit(4, "in"), height = unit(4.5, "in"), 
        column_order = 1:8, column_dend_reorder = FALSE,
        cluster_rows = METree_P, row_split = 5, row_gap = unit(2.5, "mm"), border = TRUE,
        cell_fun = function(j, i, x, y, w, h, col) {
        if(heatmappval[i, j] <= 0.05) {
            grid.text(sprintf("%s", heatmappval[i, j]), x, y, gp = gpar(fontsize = 8, fontface = "bold"))
        }
        else {
            grid.text(sprintf("%s", heatmappval[i, j]), x, y, gp = gpar(fontsize = 8, fontface = "plain"))
        }},
        column_names_gp =  gpar(fontsize = 10),
row_names_gp = gpar(fontsize = 10, alpha = 0.75, border = TRUE, fill = htmap.colors))
draw(ht)
dev.off()

```

```{r create cluster detailed dataframes Plural/Pedal}
MEcluster1 <- data.frame(moduleColor = c("turquoise"), moduleCluster = c(1))
MEcluster2 <- data.frame(moduleColor = c("brown","green"), moduleCluster = c(2))
MEcluster3 <- data.frame(moduleColor = c("pink","black","blue"), moduleCluster = c(3))
MEcluster4 <- data.frame(moduleColor = c("magenta","tan"), moduleCluster = c(4))
MEcluster5 <- data.frame(moduleColor = c("greenyellow","red"), moduleCluster = c(5))
moduleCluster = bind_rows(MEcluster1, MEcluster2, MEcluster3, MEcluster4, MEcluster5)
head(moduleCluster)

head(MEs_P)

Strader_MEs_P <- MEs_P
Strader_MEs_P$treatment <- as.character(sdat_P$treatment)
Strader_MEs_P$sample_id <- rownames(Strader_MEs_P)
head(Strader_MEs_P)

##Calculate five over-arching expression patterns using mean eigengene for each module in a cluster


C2_Strader_MEs_P <- select(Strader_MEs_P, MEbrown:MEgreen)
C2_Strader_MEs_P$Mean <- rowMeans(C2_Strader_MEs_P)
C3_Strader_MEs_P <- select(Strader_MEs_P, MEpink:MEblue)
C3_Strader_MEs_P$Mean <- rowMeans(C3_Strader_MEs_P)
C4_Strader_MEs_P <- select(Strader_MEs_P, MEmagenta:MEtan)
C4_Strader_MEs_P$Mean <- rowMeans(C4_Strader_MEs_P)
C5_Strader_MEs_P <- select(Strader_MEs_P, MEgreenyellow:MEred)
C5_Strader_MEs_P$Mean <- rowMeans(C5_Strader_MEs_P)


expressionProfile_data_P <- as.data.frame(cbind(treatment = Strader_MEs_P$treatment, cluster1= Strader_MEs_P$MEturquoise, cluster2 = C2_Strader_MEs_P$Mean, cluster3 = C3_Strader_MEs_P$Mean, cluster4 = C4_Strader_MEs_P$Mean, cluster5 = C5_Strader_MEs_P$Mean))
cols.num <- c(2:6)

expressionProfile_data_P[cols.num] <- sapply(expressionProfile_data_P[cols.num],as.numeric)
sapply(expressionProfile_data_P, class)
dim(expressionProfile_data_P)
head(expressionProfile_data_P)

treatment_order <- c("Control","Hyp_T2h","Hyp_T6h","Reox","LtH_6","LtH_7","Recovery")

```

```{r plot cluster eigengene}
# Plot mean module eigengene for each cluster

Cluster1Plot <- expressionProfile_data_P %>%
        select(treatment, cluster1) %>% 
  group_by(treatment) %>% 
  ggplot(aes(x=treatment, y=cluster1)) +
  geom_jitter(alpha = 0.5) +
  geom_boxplot(alpha=0) +
        scale_x_discrete(limits=treatment_order) +
  #ylim(-0.5,1) +
  ylab("Mean Module Eigenegene") +
  theme_bw() + 
  ggtitle("Cluster 1") +
  theme(axis.text.x=element_blank(), #set x-axis label size
        axis.title.x=element_blank(), #set x-axis title size
        axis.ticks.x=element_blank(), #No x-label ticks
        axis.title.y=element_text(size = 14), #No y-axis title
        axis.text.y=element_text(size = 14), #set y-axis label size, #No y-title
        panel.border = element_blank(), # Set border
        panel.grid.major = element_blank(), #Set major gridlines
        panel.grid.minor = element_blank(), #Set minor gridlines
        axis.line = element_line(colour = "black"), #Set axes color
        plot.background=element_blank(),
        plot.title = element_text(size=16)) + #Set the plot background
  annotate("text", x = 1.2, y = 0.5, label = "n = 1", size = 4) +
  geom_hline(yintercept = 0, linetype="dashed", color = "grey") #

Cluster2Plot <- expressionProfile_data_P %>%
        select(treatment, cluster2) %>% 
  group_by(treatment) %>% 
  ggplot(aes(x=treatment, y=cluster2)) +
  geom_jitter(alpha = 0.5) +
  geom_boxplot(alpha=0) +
        scale_x_discrete(limits=treatment_order) +
  #ylim(-0.5,1) +
  ggtitle("Cluster 2") +
  theme_bw() + 
  theme(axis.text.x=element_blank(), #set x-axis label size
        axis.title.x=element_blank(), #set x-axis title size
        axis.ticks.x=element_blank(), #No x-label ticks
        axis.title.y=element_blank(), #No y-axis title
        axis.text.y=element_text(size = 14), #set y-axis label size, #No y-title
        panel.border = element_blank(), # Set border
        panel.grid.major = element_blank(), #Set major gridlines
        panel.grid.minor = element_blank(), #Set minor gridlines
        axis.line = element_line(colour = "black"), #Set axes color
        plot.background=element_blank(),
        plot.title = element_text(size=16)) + #Set the plot background
  annotate("text", x = 1.2, y = 0.5, label = "n = 2", size = 4)  +
  geom_hline(yintercept = 0, linetype="dashed", color = "grey") #
Cluster3Plot <- expressionProfile_data_P %>%
        select(treatment, cluster3) %>% 
  group_by(treatment) %>% 
  ggplot(aes(x=treatment, y=cluster3)) +
  geom_jitter(alpha = 0.5) +
  geom_boxplot(alpha=0) +
        scale_x_discrete(limits=treatment_order) +
  #ylim(-0.5,1) +
  ggtitle("C) Cluster 3") +
  theme_bw() + 
 theme(axis.text.x=element_blank(), #set x-axis label size
        axis.title.x=element_blank(), #set x-axis title size
        axis.ticks.x=element_blank(), #No x-label ticks
        axis.title.y=element_blank(), #No y-axis title
        axis.text.y=element_text(size = 14), #set y-axis label size, #No y-title
        panel.border = element_blank(), # Set border
        panel.grid.major = element_blank(), #Set major gridlines
        panel.grid.minor = element_blank(), #Set minor gridlines
        axis.line = element_line(colour = "black"), #Set axes color
        plot.background=element_blank(),
        plot.title = element_text(size=16)) + #Set the plot background
  annotate("text", x = 1.2, y = 0.5, label = "n = 3", size = 4)  +
  geom_hline(yintercept = 0, linetype="dashed", color = "grey")
Cluster4Plot <- expressionProfile_data_P %>%
        select(treatment, cluster4) %>% 
  group_by(treatment) %>% 
  ggplot(aes(x=treatment, y=cluster4)) +
  geom_jitter(alpha = 0.5) +
  geom_boxplot(alpha=0) +
        scale_x_discrete(limits=treatment_order) +
  #ylim(-0.5,1) +
  ggtitle("Cluster 4") +
  ylab("Mean Module Eigenegene") +
  theme_bw() + 
 theme(axis.text.x=element_blank(), #set x-axis label size
        axis.title.x=element_blank(), #set x-axis title size
        axis.ticks.x=element_blank(), #No x-label ticks
        axis.title.y=element_blank(), #No y-axis title
        axis.text.y=element_text(size = 14), #set y-axis label size, #No y-title
        panel.border = element_blank(), # Set border
        panel.grid.major = element_blank(), #Set major gridlines
        panel.grid.minor = element_blank(), #Set minor gridlines
        axis.line = element_line(colour = "black"), #Set axes color
        plot.background=element_blank(),
        plot.title = element_text(size=16)) + #Set the plot background
  annotate("text", x = 1.2, y = 0.5, label = "n = 2", size = 4)  +
  geom_hline(yintercept = 0, linetype="dashed", color = "grey")
Cluster5Plot <- expressionProfile_data_P %>%
        select(treatment, cluster5) %>% 
  group_by(treatment) %>% 
  ggplot(aes(x=treatment, y=cluster5)) +
  geom_jitter(alpha = 0.5) +
  geom_boxplot(alpha=0) +
        scale_x_discrete(limits=treatment_order) +
  #ylim(-0.5,1) +
  ggtitle("Cluster 5") +
  ylab("Mean Module Eigenegene") +
  theme_bw() + 
 theme(axis.text.x=element_blank(), #set x-axis label size
        axis.title.x=element_blank(), #set x-axis title size
        axis.ticks.x=element_blank(), #No x-label ticks
        axis.title.y=element_blank(), #No y-axis title
        axis.text.y=element_text(size = 14), #set y-axis label size, #No y-title
        panel.border = element_blank(), # Set border
        panel.grid.major = element_blank(), #Set major gridlines
        panel.grid.minor = element_blank(), #Set minor gridlines
        axis.line = element_line(colour = "black"), #Set axes color
        plot.background=element_blank(),
        plot.title = element_text(size=16)) + #Set the plot background
  annotate("text", x = 1.2, y = 0.5, label = "n = 2", size = 4)  +
  geom_hline(yintercept = 0, linetype="dashed", color = "grey")

expressionProfiles_P <- cowplot::plot_grid(Cluster1Plot, Cluster2Plot, Cluster3Plot, Cluster4Plot, Cluster5Plot, align = "v", ncol = 2, nrow = 3)
ggsave("figures/SFig1-RNAseq-expressionProfiles_PleuralPedal.png", expressionProfiles_P, height = 9, width = 8, units = "in")
expressionProfiles_P
```

### Summary output of network analysis results

```{r saving modules in clusters all tissues}
# saving selected modules in clusters for GO and KOG analysis (two-parts: Fisher test, MWU test within-module)
## all tissue and batches first
# calculating cluster memberships for all genes for all modules in each cluster
allkME =as.data.frame(signedKME(datt, MEs)) 
names(allkME)=gsub("kME","",names(allkME))
# Cluster 1
whichModule=c("red")
table(moduleColors==whichModule) # how many genes are in it?
# Saving data for Fisher-MWU combo test (GO_MWU)
inModuleBinary=as.numeric(moduleColors==whichModule)
combo=data.frame("gene"=row.names(vsd.wg),"Fish_kME"=allkME[,whichModule]*inModuleBinary)
write.csv(combo,file=paste("analyses/GO_MWU/all_red.csv",sep=""),row.names=F,quote=F)
whichModule=c("blue")
table(moduleColors==whichModule) # how many genes are in it?
# Saving data for Fisher-MWU combo test (GO_MWU)
inModuleBinary=as.numeric(moduleColors==whichModule)
combo=data.frame("gene"=row.names(vsd.wg),"Fish_kME"=allkME[,whichModule]*inModuleBinary)
write.csv(combo,file=paste("analyses/GO_MWU/all_blue.csv",sep=""),row.names=F,quote=F)
#Cluster2
whichModule="greenyellow"
table(moduleColors==whichModule)
inModuleBinary=as.numeric(moduleColors==whichModule)
combo=data.frame("gene"=row.names(vsd.wg),"Fish_kME"=allkME[,whichModule]*inModuleBinary)
write.csv(combo,file=paste("analyses/GO_MWU/all_greenyellow.csv",sep=""),row.names=F,quote=F)
# Plot a heatmap with highly corrrelated genes
top=30
datME=MEs
datExpr=datt
modcol="greenyellow"
sorted=vsd.wg[order(allkME[,modcol],decreasing=T),]
head(sorted)
gg <- annot[,c(1,9)]
# selection top N named genes, attaching gene names
gnames=c();counts=0;hubs=c()
for(i in 1:length(sorted[,1])) {
	if (row.names(sorted)[i] %in% gg$gene) { 
		counts=counts+1
		gn=gg[gg$gene==row.names(sorted)[i],2]
		gn=paste(gn,row.names(sorted)[i],sep=".")
		if (gn %in% gnames) {
			gn=paste(gn,counts,sep=".")
		}
		gnames=append(gnames,gn) 
		hubs=data.frame(rbind(hubs,sorted[i,]))
		if (counts==top) {break}
	}
} 
gnames.short <- gsub(").*$", "", gnames) 
row.names(hubs)=gnames.short
contrasting = colorRampPalette(rev(c("chocolate1","#FEE090","grey10", "cyan3","cyan")))(100)
contrasting2 = colorRampPalette(rev(c("chocolate1","chocolate1","#FEE090","grey10", "cyan3","cyan","cyan")))(100)
contrasting3 = colorRampPalette(rev(c("chocolate1","#FEE090","grey10", "cyan3","cyan","cyan")))(100)
phmap <- pheatmap(hubs,scale="row",col=contrasting2,border_color=NA,treeheight_col=0.1,cex=0.9,cluster_rows=F)
ggsave(filename="output/heatmap_all_yellowgreenmodule.png", phmap, width = 14, height = 5)
#Cluster3
whichModule=c("tan")
table(moduleColors==whichModule) 
inModuleBinary=as.numeric(moduleColors==whichModule)
combo=data.frame("gene"=row.names(vsd.wg),"Fish_kME"=allkME[,whichModule]*inModuleBinary)
write.csv(combo,file=paste("analyses/GO_MWU/all_tan.csv",sep=""),row.names=F,quote=F)
whichModule=c("yellow")
table(moduleColors==whichModule) 
inModuleBinary=as.numeric(moduleColors==whichModule)
combo=data.frame("gene"=row.names(vsd.wg),"Fish_kME"=allkME[,whichModule]*inModuleBinary)
write.csv(combo,file=paste("analyses/GO_MWU/all_yellow.csv",sep=""),row.names=F,quote=F)
whichModule=c("green")
table(moduleColors==whichModule) 
inModuleBinary=as.numeric(moduleColors==whichModule)
combo=data.frame("gene"=row.names(vsd.wg),"Fish_kME"=allkME[,whichModule]*inModuleBinary)
write.csv(combo,file=paste("analyses/GO_MWU/all_green.csv",sep=""),row.names=F,quote=F)
whichModule=c("purple")
table(moduleColors==whichModule) 
inModuleBinary=as.numeric(moduleColors==whichModule)
combo=data.frame("gene"=row.names(vsd.wg),"Fish_kME"=allkME[,whichModule]*inModuleBinary)
write.csv(combo,file=paste("analyses/GO_MWU/all_purple.csv",sep=""),row.names=F,quote=F)
#Cluster4
whichModule=c("turquoise")
table(moduleColors==whichModule) 
inModuleBinary=as.numeric(moduleColors==whichModule)
combo=data.frame("gene"=row.names(vsd.wg),"Fish_kME"=allkME[,whichModule]*inModuleBinary)
write.csv(combo,file=paste("analyses/GO_MWU/all_turquoise.csv",sep=""),row.names=F,quote=F)
#Cluster5
whichModule=c("brown")
table(moduleColors==whichModule) 
inModuleBinary=as.numeric(moduleColors==whichModule)
combo=data.frame("gene"=row.names(vsd.wg),"Fish_kME"=allkME[,whichModule]*inModuleBinary)
write.csv(combo,file=paste("analyses/GO_MWU/all_brown.csv",sep=""),row.names=F,quote=F)
whichModule=c("black")
table(moduleColors==whichModule) 
inModuleBinary=as.numeric(moduleColors==whichModule)
combo=data.frame("gene"=row.names(vsd.wg),"Fish_kME"=allkME[,whichModule]*inModuleBinary)
write.csv(combo,file=paste("analyses/GO_MWU/all_black.csv",sep=""),row.names=F,quote=F)
whichModule=c("magenta")
table(moduleColors==whichModule) 
inModuleBinary=as.numeric(moduleColors==whichModule)
combo=data.frame("gene"=row.names(vsd.wg),"Fish_kME"=allkME[,whichModule]*inModuleBinary)
write.csv(combo,file=paste("analyses/GO_MWU/all_magenta.csv",sep=""),row.names=F,quote=F)
# Plot a heatmap with highly corrrelated genes
top=30
datME=MEs
datExpr=datt
modcol="brown"
sorted=vsd.wg[order(allkME[,modcol],decreasing=T),]
head(sorted)
gg <- annot[,c(1,9)]
# selection top N named genes, attaching gene names
gnames=c();counts=0;hubs=c()
for(i in 1:length(sorted[,1])) {
	if (row.names(sorted)[i] %in% gg$gene) { 
		counts=counts+1
		gn=gg[gg$gene==row.names(sorted)[i],2]
		gn=paste(gn,row.names(sorted)[i],sep=".")
		if (gn %in% gnames) {
			gn=paste(gn,counts,sep=".")
		}
		gnames=append(gnames,gn) 
		hubs=data.frame(rbind(hubs,sorted[i,]))
		if (counts==top) {break}
	}
} 
gnames.short <- gsub(").*$", "", gnames) 
row.names(hubs)=gnames.short
contrasting = colorRampPalette(rev(c("chocolate1","#FEE090","grey10", "cyan3","cyan")))(100)
contrasting2 = colorRampPalette(rev(c("chocolate1","chocolate1","#FEE090","grey10", "cyan3","cyan","cyan")))(100)
contrasting3 = colorRampPalette(rev(c("chocolate1","#FEE090","grey10", "cyan3","cyan","cyan")))(100)
phmap <- pheatmap(hubs,scale="row",col=contrasting2,border_color=NA,treeheight_col=0.1,cex=0.9,cluster_rows=F)
ggsave(filename="output/heatmap_all_brown.png", phmap, width = 14, height = 5)

```

```{r saving modules in clusters abdominal tissues}
# saving selected modules in clusters for GO and KOG analysis (two-parts: Fisher test, MWU test within-module)
## abdominal tissue and batches first
# calculating cluster memberships for abdominal genes for abdominal modules in each cluster
abdominalkME =as.data.frame(signedKME(datt_A, MEs_A)) 
names(abdominalkME)=gsub("kME","",names(abdominalkME))
# Cluster 1
whichModule=c("turquoise")
table(moduleColors==whichModule) # how many genes are in it?
# Saving data for Fisher-MWU combo test (GO_MWU)
inModuleBinary=as.numeric(moduleColors==whichModule)
combo=data.frame("gene"=row.names(vsd.wg),"Fish_kME"=abdominalkME[,whichModule]*inModuleBinary)
write.csv(combo,file=paste("analyses/GO_MWU/abdominal_turquoise.csv",sep=""),row.names=F,quote=F)
#Cluster2
whichModule=c("purple")
table(moduleColors==whichModule)
inModuleBinary=as.numeric(moduleColors==whichModule)
combo=data.frame("gene"=row.names(vsd.wg),"Fish_kME"=abdominalkME[,whichModule]*inModuleBinary)
write.csv(combo,file=paste("analyses/GO_MWU/abdominal_purple.csv",sep=""),row.names=F,quote=F)
whichModule=c("magenta")
table(moduleColors==whichModule)
inModuleBinary=as.numeric(moduleColors==whichModule)
combo=data.frame("gene"=row.names(vsd.wg),"Fish_kME"=abdominalkME[,whichModule]*inModuleBinary)
write.csv(combo,file=paste("analyses/GO_MWU/abdominal_magenta.csv",sep=""),row.names=F,quote=F)
# Plot a heatmap with highly corrrelated genes module purple
top=30
datME=MEs_A
datExpr=datt_A
modcol="purple"
sorted=vsd.wg_A[order(abdominalkME[,modcol],decreasing=T),]
head(sorted)
gg <- annot[,c(1,9)]
# selection top N named genes, attaching gene names
gnames=c();counts=0;hubs=c()
for(i in 1:length(sorted[,1])) {
	if (row.names(sorted)[i] %in% gg$gene) { 
		counts=counts+1
		gn=gg[gg$gene==row.names(sorted)[i],2]
		gn=paste(gn,row.names(sorted)[i],sep=".")
		if (gn %in% gnames) {
			gn=paste(gn,counts,sep=".")
		}
		gnames=append(gnames,gn) 
		hubs=data.frame(rbind(hubs,sorted[i,]))
		if (counts==top) {break}
	}
} 
gnames.short <- gsub(").*$", "", gnames) 
row.names(hubs)=gnames.short
contrasting = colorRampPalette(rev(c("chocolate1","#FEE090","grey10", "cyan3","cyan")))(100)
contrasting2 = colorRampPalette(rev(c("chocolate1","chocolate1","#FEE090","grey10", "cyan3","cyan","cyan")))(100)
contrasting3 = colorRampPalette(rev(c("chocolate1","#FEE090","grey10", "cyan3","cyan","cyan")))(100)
phmap <- pheatmap(hubs,scale="row",col=contrasting2,border_color=NA,treeheight_col=0.1,cex=0.9,cluster_rows=F,cluster_cols = F)
ggsave(filename="output/heatmap_A_purple.png", phmap, width = 14, height = 5)
# Plot a heatmap with highly corrrelated genes module magenta
top=30
datME=MEs_A
datExpr=datt_A
modcol="magenta"
sorted=vsd.wg_A[order(abdominalkME[,modcol],decreasing=T),]
head(sorted)
gg <- annot[,c(1,9)]
# selection top N named genes, attaching gene names
gnames=c();counts=0;hubs=c()
for(i in 1:length(sorted[,1])) {
	if (row.names(sorted)[i] %in% gg$gene) { 
		counts=counts+1
		gn=gg[gg$gene==row.names(sorted)[i],2]
		gn=paste(gn,row.names(sorted)[i],sep=".")
		if (gn %in% gnames) {
			gn=paste(gn,counts,sep=".")
		}
		gnames=append(gnames,gn) 
		hubs=data.frame(rbind(hubs,sorted[i,]))
		if (counts==top) {break}
	}
} 
gnames.short <- gsub(").*$", "", gnames) 
row.names(hubs)=gnames.short
contrasting = colorRampPalette(rev(c("chocolate1","#FEE090","grey10", "cyan3","cyan")))(100)
contrasting2 = colorRampPalette(rev(c("chocolate1","chocolate1","#FEE090","grey10", "cyan3","cyan","cyan")))(100)
contrasting3 = colorRampPalette(rev(c("chocolate1","#FEE090","grey10", "cyan3","cyan","cyan")))(100)
phmap <- pheatmap(hubs,scale="row",col=contrasting2,border_color=NA,treeheight_col=0.1,cex=0.9,cluster_rows=F,cluster_cols = F)
ggsave(filename="output/heatmap_A_magenta.png", phmap, width = 14, height = 5)
#Cluster3
whichModule=c("brown")
table(moduleColors==whichModule) 
inModuleBinary=as.numeric(moduleColors==whichModule)
combo=data.frame("gene"=row.names(vsd.wg),"Fish_kME"=abdominalkME[,whichModule]*inModuleBinary)
write.csv(combo,file=paste("analyses/GO_MWU/abdominal_brown.csv",sep=""),row.names=F,quote=F)
# Plot a heatmap with highly corrrelated genes module brown
top=30
datME=MEs_A
datExpr=datt_A
modcol="brown"
sorted=vsd.wg_A[order(abdominalkME[,modcol],decreasing=T),]
head(sorted)
gg <- annot[,c(1,9)]
# selection top N named genes, attaching gene names
gnames=c();counts=0;hubs=c()
for(i in 1:length(sorted[,1])) {
	if (row.names(sorted)[i] %in% gg$gene) { 
		counts=counts+1
		gn=gg[gg$gene==row.names(sorted)[i],2]
		gn=paste(gn,row.names(sorted)[i],sep=".")
		if (gn %in% gnames) {
			gn=paste(gn,counts,sep=".")
		}
		gnames=append(gnames,gn) 
		hubs=data.frame(rbind(hubs,sorted[i,]))
		if (counts==top) {break}
	}
} 
gnames.short <- gsub(").*$", "", gnames) 
row.names(hubs)=gnames.short
contrasting = colorRampPalette(rev(c("chocolate1","#FEE090","grey10", "cyan3","cyan")))(100)
contrasting2 = colorRampPalette(rev(c("chocolate1","chocolate1","#FEE090","grey10", "cyan3","cyan","cyan")))(100)
contrasting3 = colorRampPalette(rev(c("chocolate1","#FEE090","grey10", "cyan3","cyan","cyan")))(100)
phmap <- pheatmap(hubs,scale="row",col=contrasting2,border_color=NA,treeheight_col=0.1,cex=0.9,cluster_rows=F,cluster_cols = F)
ggsave(filename="output/heatmap_A_brown.png", phmap, width = 14, height = 5)
#Cluster4
whichModule=c("pink")
table(moduleColors==whichModule) 
inModuleBinary=as.numeric(moduleColors==whichModule)
combo=data.frame("gene"=row.names(vsd.wg),"Fish_kME"=abdominalkME[,whichModule]*inModuleBinary)
write.csv(combo,file=paste("analyses/GO_MWU/abdominal_pink.csv",sep=""),row.names=F,quote=F)
whichModule=c("green")
table(moduleColors==whichModule) 
inModuleBinary=as.numeric(moduleColors==whichModule)
combo=data.frame("gene"=row.names(vsd.wg),"Fish_kME"=abdominalkME[,whichModule]*inModuleBinary)
write.csv(combo,file=paste("analyses/GO_MWU/abdominal_green.csv",sep=""),row.names=F,quote=F)
# Plot a heatmap with highly corrrelated genes module pink
top=30
datME=MEs_A
datExpr=datt_A
modcol="pink"
sorted=vsd.wg_A[order(abdominalkME[,modcol],decreasing=T),]
head(sorted)
gg <- annot[,c(1,9)]
# selection top N named genes, attaching gene names
gnames=c();counts=0;hubs=c()
for(i in 1:length(sorted[,1])) {
	if (row.names(sorted)[i] %in% gg$gene) { 
		counts=counts+1
		gn=gg[gg$gene==row.names(sorted)[i],2]
		gn=paste(gn,row.names(sorted)[i],sep=".")
		if (gn %in% gnames) {
			gn=paste(gn,counts,sep=".")
		}
		gnames=append(gnames,gn) 
		hubs=data.frame(rbind(hubs,sorted[i,]))
		if (counts==top) {break}
	}
} 
gnames.short <- gsub(").*$", "", gnames) 
gnames.short[7] <- paste(gnames.short[7], "iso", sep = " ")
gnames.short[6] <- paste(gnames.short[6], "iso", sep = " ")
gnames.short[15] <- paste(gnames.short[6], "2", sep = " ")
row.names(hubs)=gnames.short
contrasting = colorRampPalette(rev(c("chocolate1","#FEE090","grey10", "cyan3","cyan")))(100)
contrasting2 = colorRampPalette(rev(c("chocolate1","chocolate1","#FEE090","grey10", "cyan3","cyan","cyan")))(100)
contrasting3 = colorRampPalette(rev(c("chocolate1","#FEE090","grey10", "cyan3","cyan","cyan")))(100)
phmap <- pheatmap(hubs,scale="row",col=contrasting2,border_color=NA,treeheight_col=0.1,cex=0.9,cluster_rows=F,cluster_cols = F)
ggsave(filename="output/heatmap_A_pink.png", phmap, width = 14, height = 5)
# Plot a heatmap with highly corrrelated genes module brown
top=30
datME=MEs_A
datExpr=datt_A
modcol="green"
sorted=vsd.wg_A[order(abdominalkME[,modcol],decreasing=T),]
head(sorted)
gg <- annot[,c(1,9)]
# selection top N named genes, attaching gene names
gnames=c();counts=0;hubs=c()
for(i in 1:length(sorted[,1])) {
	if (row.names(sorted)[i] %in% gg$gene) { 
		counts=counts+1
		gn=gg[gg$gene==row.names(sorted)[i],2]
		gn=paste(gn,row.names(sorted)[i],sep=".")
		if (gn %in% gnames) {
			gn=paste(gn,counts,sep=".")
		}
		gnames=append(gnames,gn) 
		hubs=data.frame(rbind(hubs,sorted[i,]))
		if (counts==top) {break}
	}
} 
gnames.short <- gsub(").*$", "", gnames) 
gnames.short[21] <- paste(gnames.short[21], "iso", sep = " ")
gnames.short[9] <- paste(gnames.short[9], "2", sep = " ")
row.names(hubs)=gnames.short
contrasting = colorRampPalette(rev(c("chocolate1","#FEE090","grey10", "cyan3","cyan")))(100)
contrasting2 = colorRampPalette(rev(c("chocolate1","chocolate1","#FEE090","grey10", "cyan3","cyan","cyan")))(100)
contrasting3 = colorRampPalette(rev(c("chocolate1","#FEE090","grey10", "cyan3","cyan","cyan")))(100)
phmap <- pheatmap(hubs,scale="row",col=contrasting2,border_color=NA,treeheight_col=0.1,cex=0.9,cluster_rows=F,cluster_cols = F)
ggsave(filename="output/heatmap_A_green.png", phmap, width = 14, height = 5)
```

```{r saving modules in clusters PleuPed tissues}
# saving selected modules in clusters for GO and KOG analysis (two-parts: Fisher test, MWU test within-module)
## PleuPed tissue and batches first
# calculating cluster memberships for PleuPed genes for PleuPed modules in each cluster
PleuPedkME =as.data.frame(signedKME(datt_P, MEs_P)) 
names(PleuPedkME)=gsub("kME","",names(PleuPedkME))
# Cluster 1
whichModule=c("turquoise")
table(moduleColors==whichModule) # how many genes are in it?
# Saving data for Fisher-MWU combo test (GO_MWU)
inModuleBinary=as.numeric(moduleColors==whichModule)
combo=data.frame("gene"=row.names(vsd.wg),"Fish_kME"=PleuPedkME[,whichModule]*inModuleBinary)
write.csv(combo,file=paste("analyses/GO_MWU/PleuPed_turquoise.csv",sep=""),row.names=F,quote=F)
#Cluster2
whichModule=c("brown")
table(moduleColors==whichModule)
inModuleBinary=as.numeric(moduleColors==whichModule)
combo=data.frame("gene"=row.names(vsd.wg),"Fish_kME"=PleuPedkME[,whichModule]*inModuleBinary)
write.csv(combo,file=paste("analyses/GO_MWU/PleuPed_brown.csv",sep=""),row.names=F,quote=F)
whichModule=c("green")
table(moduleColors==whichModule)
inModuleBinary=as.numeric(moduleColors==whichModule)
combo=data.frame("gene"=row.names(vsd.wg),"Fish_kME"=PleuPedkME[,whichModule]*inModuleBinary)
write.csv(combo,file=paste("analyses/GO_MWU/PleuPed_green.csv",sep=""),row.names=F,quote=F)
# Plot a heatmap with highly corrrelated genes module green
top=30
datME=MEs_P
datExpr=datt_P
modcol="brown"
sorted=vsd.wg_P[order(PleuPedkME[,modcol],decreasing=T),]
head(sorted)
gg <- annot[,c(1,9)]
# selection top N named genes, attaching gene names
gnames=c();counts=0;hubs=c()
for(i in 1:length(sorted[,1])) {
	if (row.names(sorted)[i] %in% gg$gene) { 
		counts=counts+1
		gn=gg[gg$gene==row.names(sorted)[i],2]
		gn=paste(gn,row.names(sorted)[i],sep=".")
		if (gn %in% gnames) {
			gn=paste(gn,counts,sep=".")
		}
		gnames=append(gnames,gn) 
		hubs=data.frame(rbind(hubs,sorted[i,]))
		if (counts==top) {break}
	}
} 
gnames.short <- gsub(").*$", "", gnames) 
gnames.short[13] <- paste(gnames.short[13], "iso", sep = " ")
gnames.short[6] <- paste(gnames.short[6], "iso", sep = " ")
gnames.short[19] <- paste(gnames.short[6], "2", sep = " ")
row.names(hubs)=gnames.short
contrasting = colorRampPalette(rev(c("chocolate1","#FEE090","grey10", "cyan3","cyan")))(100)
contrasting2 = colorRampPalette(rev(c("chocolate1","chocolate1","#FEE090","grey10", "cyan3","cyan","cyan")))(100)
contrasting3 = colorRampPalette(rev(c("chocolate1","#FEE090","grey10", "cyan3","cyan","cyan")))(100)
phmap <- pheatmap(hubs,scale="row",col=contrasting2,border_color=NA,treeheight_col=0.1,cex=0.9,cluster_rows=F,cluster_cols = F)
ggsave(filename="output/heatmap_P_brown.png", phmap, width = 14, height = 5)
# Plot a heatmap with highly corrrelated genes module green
top=30
datME=MEs_P
datExpr=datt_P
modcol="green"
sorted=vsd.wg_P[order(PleuPedkME[,modcol],decreasing=T),]
head(sorted)
gg <- annot[,c(1,9)]
# selection top N named genes, attaching gene names
gnames=c();counts=0;hubs=c()
for(i in 1:length(sorted[,1])) {
	if (row.names(sorted)[i] %in% gg$gene) { 
		counts=counts+1
		gn=gg[gg$gene==row.names(sorted)[i],2]
		gn=paste(gn,row.names(sorted)[i],sep=".")
		if (gn %in% gnames) {
			gn=paste(gn,counts,sep=".")
		}
		gnames=append(gnames,gn) 
		hubs=data.frame(rbind(hubs,sorted[i,]))
		if (counts==top) {break}
	}
} 
gnames.short <- gsub(").*$", "", gnames) 
row.names(hubs)=gnames.short
contrasting = colorRampPalette(rev(c("chocolate1","#FEE090","grey10", "cyan3","cyan")))(100)
contrasting2 = colorRampPalette(rev(c("chocolate1","chocolate1","#FEE090","grey10", "cyan3","cyan","cyan")))(100)
contrasting3 = colorRampPalette(rev(c("chocolate1","#FEE090","grey10", "cyan3","cyan","cyan")))(100)
phmap <- pheatmap(hubs,scale="row",col=contrasting2,border_color=NA,treeheight_col=0.1,cex=0.9,cluster_rows=F,cluster_cols = F)
ggsave(filename="output/heatmap_P_green.png", phmap, width = 14, height = 5)
#Cluster3
whichModule=c("pink")
table(moduleColors==whichModule) 
inModuleBinary=as.numeric(moduleColors==whichModule)
combo=data.frame("gene"=row.names(vsd.wg),"Fish_kME"=PleuPedkME[,whichModule]*inModuleBinary)
write.csv(combo,file=paste("analyses/GO_MWU/PleuPed_pink.csv",sep=""),row.names=F,quote=F)
whichModule=c("black")
table(moduleColors==whichModule) 
inModuleBinary=as.numeric(moduleColors==whichModule)
combo=data.frame("gene"=row.names(vsd.wg),"Fish_kME"=PleuPedkME[,whichModule]*inModuleBinary)
write.csv(combo,file=paste("analyses/GO_MWU/PleuPed_black.csv",sep=""),row.names=F,quote=F)
# Plot a heatmap with highly corrrelated genes module pink
top=30
datME=MEs_P
datExpr=datt_P
modcol="pink"
sorted=vsd.wg_P[order(PleuPedkME[,modcol],decreasing=T),]
head(sorted)
gg <- annot[,c(1,9)]
# selection top N named genes, attaching gene names
gnames=c();counts=0;hubs=c()
for(i in 1:length(sorted[,1])) {
	if (row.names(sorted)[i] %in% gg$gene) { 
		counts=counts+1
		gn=gg[gg$gene==row.names(sorted)[i],2]
		gn=paste(gn,row.names(sorted)[i],sep=".")
		if (gn %in% gnames) {
			gn=paste(gn,counts,sep=".")
		}
		gnames=append(gnames,gn) 
		hubs=data.frame(rbind(hubs,sorted[i,]))
		if (counts==top) {break}
	}
} 
gnames.short <- gsub(").*$", "", gnames) 
row.names(hubs)=gnames.short
contrasting = colorRampPalette(rev(c("chocolate1","#FEE090","grey10", "cyan3","cyan")))(100)
contrasting2 = colorRampPalette(rev(c("chocolate1","chocolate1","#FEE090","grey10", "cyan3","cyan","cyan")))(100)
contrasting3 = colorRampPalette(rev(c("chocolate1","#FEE090","grey10", "cyan3","cyan","cyan")))(100)
phmap <- pheatmap(hubs,scale="row",col=contrasting2,border_color=NA,treeheight_col=0.1,cex=0.9,cluster_rows=F,cluster_cols = F)
ggsave(filename="output/heatmap_P_pink.png", phmap, width = 14, height = 5)
# Plot a heatmap with highly corrrelated genes module black
top=30
datME=MEs_P
datExpr=datt_P
modcol="black"
sorted=vsd.wg_P[order(PleuPedkME[,modcol],decreasing=T),]
head(sorted)
gg <- annot[,c(1,9)]
# selection top N named genes, attaching gene names
gnames=c();counts=0;hubs=c()
for(i in 1:length(sorted[,1])) {
	if (row.names(sorted)[i] %in% gg$gene) { 
		counts=counts+1
		gn=gg[gg$gene==row.names(sorted)[i],2]
		gn=paste(gn,row.names(sorted)[i],sep=".")
		if (gn %in% gnames) {
			gn=paste(gn,counts,sep=".")
		}
		gnames=append(gnames,gn) 
		hubs=data.frame(rbind(hubs,sorted[i,]))
		if (counts==top) {break}
	}
} 
gnames.short <- gsub(").*$", "", gnames) 
row.names(hubs)=gnames.short
contrasting = colorRampPalette(rev(c("chocolate1","#FEE090","grey10", "cyan3","cyan")))(100)
contrasting2 = colorRampPalette(rev(c("chocolate1","chocolate1","#FEE090","grey10", "cyan3","cyan","cyan")))(100)
contrasting3 = colorRampPalette(rev(c("chocolate1","#FEE090","grey10", "cyan3","cyan","cyan")))(100)
phmap <- pheatmap(hubs,scale="row",col=contrasting2,border_color=NA,treeheight_col=0.1,cex=0.9,cluster_rows=F,cluster_cols = F)
ggsave(filename="output/heatmap_P_black.png", phmap, width = 14, height = 5)
#Cluster4
whichModule=c("magenta")
table(moduleColors==whichModule) 
inModuleBinary=as.numeric(moduleColors==whichModule)
combo=data.frame("gene"=row.names(vsd.wg),"Fish_kME"=PleuPedkME[,whichModule]*inModuleBinary)
write.csv(combo,file=paste("analyses/GO_MWU/PleuPed_magenta.csv",sep=""),row.names=F,quote=F)
whichModule=c("tan")
table(moduleColors==whichModule) 
inModuleBinary=as.numeric(moduleColors==whichModule)
combo=data.frame("gene"=row.names(vsd.wg),"Fish_kME"=PleuPedkME[,whichModule]*inModuleBinary)
write.csv(combo,file=paste("analyses/GO_MWU/PleuPed_tan.csv",sep=""),row.names=F,quote=F)
# Plot a heatmap with highly corrrelated genes module magenta
top=30
datME=MEs_P
datExpr=datt_P
modcol="magenta"
sorted=vsd.wg_P[order(PleuPedkME[,modcol],decreasing=T),]
head(sorted)
gg <- annot[,c(1,9)]
# selection top N named genes, attaching gene names
gnames=c();counts=0;hubs=c()
for(i in 1:length(sorted[,1])) {
	if (row.names(sorted)[i] %in% gg$gene) { 
		counts=counts+1
		gn=gg[gg$gene==row.names(sorted)[i],2]
		gn=paste(gn,row.names(sorted)[i],sep=".")
		if (gn %in% gnames) {
			gn=paste(gn,counts,sep=".")
		}
		gnames=append(gnames,gn) 
		hubs=data.frame(rbind(hubs,sorted[i,]))
		if (counts==top) {break}
	}
} 
gnames.short <- gsub(").*$", "", gnames) 
gnames.short[26] <- paste(gnames.short[26], "iso", sep = " ")
gnames.short[29] <- paste(gnames.short[26], "2", sep = " ")
gnames.short[4] <- paste(gnames.short[4], "iso", sep = " ")
row.names(hubs)=gnames.short
contrasting = colorRampPalette(rev(c("chocolate1","#FEE090","grey10", "cyan3","cyan")))(100)
contrasting2 = colorRampPalette(rev(c("chocolate1","chocolate1","#FEE090","grey10", "cyan3","cyan","cyan")))(100)
contrasting3 = colorRampPalette(rev(c("chocolate1","#FEE090","grey10", "cyan3","cyan","cyan")))(100)
phmap <- pheatmap(hubs,scale="row",col=contrasting2,border_color=NA,treeheight_col=0.1,cex=0.9,cluster_rows=F,cluster_cols = F)
ggsave(filename="output/heatmap_P_magenta.png", phmap, width = 14, height = 5)
# Plot a heatmap with highly corrrelated genes module tan
top=30
datME=MEs_P
datExpr=datt_P
modcol="tan"
sorted=vsd.wg_P[order(PleuPedkME[,modcol],decreasing=T),]
head(sorted)
gg <- annot[,c(1,9)]
# selection top N named genes, attaching gene names
gnames=c();counts=0;hubs=c()
for(i in 1:length(sorted[,1])) {
	if (row.names(sorted)[i] %in% gg$gene) { 
		counts=counts+1
		gn=gg[gg$gene==row.names(sorted)[i],2]
		gn=paste(gn,row.names(sorted)[i],sep=".")
		if (gn %in% gnames) {
			gn=paste(gn,counts,sep=".")
		}
		gnames=append(gnames,gn) 
		hubs=data.frame(rbind(hubs,sorted[i,]))
		if (counts==top) {break}
	}
} 
gnames.short <- gsub(").*$", "", gnames) 
gnames.short[22] <- paste(gnames.short[22], "iso", sep = " ")
row.names(hubs)=gnames.short
contrasting = colorRampPalette(rev(c("chocolate1","#FEE090","grey10", "cyan3","cyan")))(100)
contrasting2 = colorRampPalette(rev(c("chocolate1","chocolate1","#FEE090","grey10", "cyan3","cyan","cyan")))(100)
contrasting3 = colorRampPalette(rev(c("chocolate1","#FEE090","grey10", "cyan3","cyan","cyan")))(100)
phmap <- pheatmap(hubs,scale="row",col=contrasting2,border_color=NA,treeheight_col=0.1,cex=0.9,cluster_rows=F,cluster_cols = F)
ggsave(filename="output/heatmap_P_tan.png", phmap, width = 14, height = 5)
#Cluster5
whichModule=c("red")
table(moduleColors==whichModule) 
inModuleBinary=as.numeric(moduleColors==whichModule)
combo=data.frame("gene"=row.names(vsd.wg),"Fish_kME"=PleuPedkME[,whichModule]*inModuleBinary)
write.csv(combo,file=paste("analyses/GO_MWU/PleuPed_red.csv",sep=""),row.names=F,quote=F)
# Plot a heatmap with highly corrrelated genes module red
top=30
datME=MEs_P
datExpr=datt_P
modcol="red"
sorted=vsd.wg_P[order(PleuPedkME[,modcol],decreasing=T),]
head(sorted)
gg <- annot[,c(1,9)]
# selection top N named genes, attaching gene names
gnames=c();counts=0;hubs=c()
for(i in 1:length(sorted[,1])) {
	if (row.names(sorted)[i] %in% gg$gene) { 
		counts=counts+1
		gn=gg[gg$gene==row.names(sorted)[i],2]
		gn=paste(gn,row.names(sorted)[i],sep=".")
		if (gn %in% gnames) {
			gn=paste(gn,counts,sep=".")
		}
		gnames=append(gnames,gn) 
		hubs=data.frame(rbind(hubs,sorted[i,]))
		if (counts==top) {break}
	}
} 
gnames.short <- gsub(").*$", "", gnames) 
row.names(hubs)=gnames.short
contrasting = colorRampPalette(rev(c("chocolate1","#FEE090","grey10", "cyan3","cyan")))(100)
contrasting2 = colorRampPalette(rev(c("chocolate1","chocolate1","#FEE090","grey10", "cyan3","cyan","cyan")))(100)
contrasting3 = colorRampPalette(rev(c("chocolate1","#FEE090","grey10", "cyan3","cyan","cyan")))(100)
phmap <- pheatmap(hubs,scale="row",col=contrasting2,border_color=NA,treeheight_col=0.1,cex=0.9,cluster_rows=F,cluster_cols = F)
ggsave(filename="output/heatmap_P_red.png", phmap, width = 14, height = 5)
```


#### Make a dataframe that connects traits, genes, and gene annotation for all tissue first

Import annotation file.
```{r}
annot <- read_tsv( "analyses/annotation/AplCal3_full_annotation.tsv", col_names = TRUE) #biological annotation information
tail(annot)
dim(annot)
```

Match up genes in datExpr to annotation file
```{r}
names(annot)
probes = colnames(datt)
probes2annot = match(probes, annot$gene)
# The following is the number of probes without annotation... Should return 0.
sum(is.na(probes2annot))
```

Colors of the modules
```{r}
time_point <- as.data.frame(c(as.numeric(sdat2$treatment)))
names(time_point) = "timepoint"
dim(time_point)

modNames = substring(names(MEs), 3)
geneModuleMembership = as.data.frame(cor(datt, MEs, use = "p"));
MMPvalue = as.data.frame(corPvalueStudent(as.matrix(geneModuleMembership), nSamples));
names(geneModuleMembership) = paste("MM", modNames, sep="");
names(MMPvalue) = paste("p.MM", modNames, sep="");
geneTraitSignificance = as.data.frame(cor(datt, time_point, use = "p"));
GSPvalue = as.data.frame(corPvalueStudent(as.matrix(geneTraitSignificance), nSamples));
names(geneTraitSignificance) = paste("GS.", names(time_point), sep="");
names(GSPvalue) = paste("p.GS.", names(time_point), sep="");
```

Create the starting data frame for all tissue together
```{r}
geneInfo0 = data.frame(gene_id = probes,
Accession = annot$tx[probes2annot],
eValue = annot$evalue[probes2annot],
Description = annot$Protein.names[probes2annot],
KEGG = annot$ko[probes2annot],
Annotation.GO.ID = annot$Gene.Ontology.IDs[probes2annot],
Annotation.GO.Term = annot$Gene.Ontology..GO.[probes2annot],
moduleColor = moduleColors,
geneTraitSignificance,
GSPvalue)

# Order modules by their significance for time_point
modOrder = order(-abs(cor(MEs, time_point, use = "p")))

# Add module membership information in the chosen order

for (mod in 1:ncol(geneModuleMembership))
{
oldNames = names(geneInfo0)
geneInfo0 = data.frame(geneInfo0, geneModuleMembership[, modOrder[mod]],
MMPvalue[, modOrder[mod]]);
names(geneInfo0) = c(oldNames, paste("MM.", modNames[modOrder[mod]], sep=""),
paste("p.MM.", modNames[modOrder[mod]], sep=""))
}

# Order the genes in the geneInfo variable first by module color, then by geneTraitSignificance

geneOrder = order(geneInfo0$moduleColor, -abs(geneInfo0$GS.timepoint));
geneInfo = geneInfo0[geneOrder, ]
head(geneInfo)

# Add module cluster in geneInfo

geneInfo <- left_join(geneInfo, moduleCluster, by = "moduleColor")
dim(geneInfo)
head(geneInfo)

#Save geneInfo as a CSV

head(geneInfo)
geneInfo$Annotation.GO.ID <- gsub(";NA", "", geneInfo$Annotation.GO.ID) #Remove NAs
geneInfo$Annotation.GO.ID <- gsub("NA", "", geneInfo$Annotation.GO.ID) #Remove NAs
write.csv(geneInfo, file = "output/geneInfo.csv")
```

Create starting data frame for Abdominal
```{r}

time_point <- as.data.frame(c(as.numeric(sdat_A$treatment)))
names(time_point) = "timepoint"
dim(time_point)

modNames = substring(names(MEs_A), 3)
geneModuleMembership = as.data.frame(cor(datt_A, MEs_A, use = "p"));
MMPvalue = as.data.frame(corPvalueStudent(as.matrix(geneModuleMembership), nSamples));
names(geneModuleMembership) = paste("MM", modNames, sep="");
names(MMPvalue) = paste("p.MM", modNames, sep="");
geneTraitSignificance = as.data.frame(cor(datt_A, time_point, use = "p"));
GSPvalue = as.data.frame(corPvalueStudent(as.matrix(geneTraitSignificance), nSamples));
names(geneTraitSignificance) = paste("GS.", names(time_point), sep="");
names(GSPvalue) = paste("p.GS.", names(time_point), sep="");

geneInfo0 = data.frame(gene_id = probes,
Accession = annot$tx[probes2annot],
eValue = annot$evalue[probes2annot],
Description = annot$Protein.names[probes2annot],
KEGG = annot$ko[probes2annot],
Annotation.GO.ID = annot$Gene.Ontology.IDs[probes2annot],
Annotation.GO.Term = annot$Gene.Ontology..GO.[probes2annot],
moduleColor = moduleColors,
geneTraitSignificance,
GSPvalue)

# Order modules by their significance for time_point
modOrder = order(-abs(cor(MEs_A, time_point, use = "p")))

# Add module membership information in the chosen order

for (mod in 1:ncol(geneModuleMembership))
{
oldNames = names(geneInfo0)
geneInfo0 = data.frame(geneInfo0, geneModuleMembership[, modOrder[mod]],
MMPvalue[, modOrder[mod]]);
names(geneInfo0) = c(oldNames, paste("MM.", modNames[modOrder[mod]], sep=""),
paste("p.MM.", modNames[modOrder[mod]], sep=""))
}

# Order the genes in the geneInfo variable first by module color, then by geneTraitSignificance

geneOrder = order(geneInfo0$moduleColor, -abs(geneInfo0$GS.timepoint));
geneInfo = geneInfo0[geneOrder, ]
head(geneInfo)

# Add module cluster in geneInfo

geneInfo <- left_join(geneInfo, moduleCluster, by = "moduleColor")
dim(geneInfo)
head(geneInfo)

#Save geneInfo as a CSV

head(geneInfo)
geneInfo$Annotation.GO.ID <- gsub(";NA", "", geneInfo$Annotation.GO.ID) #Remove NAs
geneInfo$Annotation.GO.ID <- gsub("NA", "", geneInfo$Annotation.GO.ID) #Remove NAs
write.csv(geneInfo, file = "output/geneInfo_Abdominal.csv")
```

Create starting data frame for Pleural Pedal
```{r}

time_point <- as.data.frame(c(as.numeric(sdat_P$treatment)))
names(time_point) = "timepoint"
dim(time_point)

modNames = substring(names(MEs_P), 3)
geneModuleMembership = as.data.frame(cor(datt_P, MEs_P, use = "p"));
MMPvalue = as.data.frame(corPvalueStudent(as.matrix(geneModuleMembership), nSamples));
names(geneModuleMembership) = paste("MM", modNames, sep="");
names(MMPvalue) = paste("p.MM", modNames, sep="");
geneTraitSignificance = as.data.frame(cor(datt_P, time_point, use = "p"));
GSPvalue = as.data.frame(corPvalueStudent(as.matrix(geneTraitSignificance), nSamples));
names(geneTraitSignificance) = paste("GS.", names(time_point), sep="");
names(GSPvalue) = paste("p.GS.", names(time_point), sep="");

geneInfo0 = data.frame(gene_id = probes,
Accession = annot$tx[probes2annot],
eValue = annot$evalue[probes2annot],
Description = annot$Protein.names[probes2annot],
KEGG = annot$ko[probes2annot],
Annotation.GO.ID = annot$Gene.Ontology.IDs[probes2annot],
Annotation.GO.Term = annot$Gene.Ontology..GO.[probes2annot],
moduleColor = moduleColors,
geneTraitSignificance,
GSPvalue)

# Order modules by their significance for time_point
modOrder = order(-abs(cor(MEs_P, time_point, use = "p")))

# Add module membership information in the chosen order

for (mod in 1:ncol(geneModuleMembership))
{
oldNames = names(geneInfo0)
geneInfo0 = data.frame(geneInfo0, geneModuleMembership[, modOrder[mod]],
MMPvalue[, modOrder[mod]]);
names(geneInfo0) = c(oldNames, paste("MM.", modNames[modOrder[mod]], sep=""),
paste("p.MM.", modNames[modOrder[mod]], sep=""))
}

# Order the genes in the geneInfo variable first by module color, then by geneTraitSignificance

geneOrder = order(geneInfo0$moduleColor, -abs(geneInfo0$GS.timepoint));
geneInfo = geneInfo0[geneOrder, ]
head(geneInfo)

# Add module cluster in geneInfo

geneInfo <- left_join(geneInfo, moduleCluster, by = "moduleColor")
dim(geneInfo)
head(geneInfo)

#Save geneInfo as a CSV

head(geneInfo)
geneInfo$Annotation.GO.ID <- gsub(";NA", "", geneInfo$Annotation.GO.ID) #Remove NAs
geneInfo$Annotation.GO.ID <- gsub("NA", "", geneInfo$Annotation.GO.ID) #Remove NAs
write.csv(geneInfo, file = "output/geneInfo_PleuralPedal.csv")
```